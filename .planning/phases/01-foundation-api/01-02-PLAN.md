---
phase: 01-foundation-api
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - app/api/chat/route.ts
autonomous: true

must_haves:
  truths:
    - "POST /api/chat with valid messages, topic, and apiKey returns JSON with displayText, concepts, confidenceCheck, and journalEntry fields"
    - "POST /api/chat without apiKey in development mode falls back to ANTHROPIC_API_KEY env var and succeeds"
    - "POST /api/chat without apiKey in production mode returns 401 with descriptive error"
    - "Response with stop_reason 'max_tokens' returns 422 error instead of broken JSON"
    - "Invalid API key returns 401 with user-friendly message"
    - "Rate-limited requests return 429 with retry guidance"
    - "existingConcepts from the request body are passed into buildSystemPrompt for parentId consistency"
    - "The API route uses Node.js runtime (no Edge Runtime export)"
  artifacts:
    - path: "app/api/chat/route.ts"
      provides: "POST handler proxying Claude API calls with BYOK, structured outputs, and stop_reason validation"
      exports: ["POST"]
  key_links:
    - from: "app/api/chat/route.ts"
      to: "lib/types.ts"
      via: "imports TurnResponseSchema for zodOutputFormat"
      pattern: "import.*TurnResponseSchema.*from.*lib/types"
    - from: "app/api/chat/route.ts"
      to: "lib/system-prompt.ts"
      via: "imports buildSystemPrompt for system message construction"
      pattern: "import.*buildSystemPrompt.*from.*lib/system-prompt"
    - from: "app/api/chat/route.ts"
      to: "@anthropic-ai/sdk"
      via: "creates per-request Anthropic client with BYOK key"
      pattern: "new Anthropic.*apiKey"
    - from: "app/api/chat/route.ts"
      to: "@anthropic-ai/sdk/helpers/zod"
      via: "converts TurnResponseSchema to output_config format"
      pattern: "zodOutputFormat.*TurnResponseSchema"
---

<objective>
Build the API route that proxies Claude calls with BYOK support, structured outputs, stop_reason validation, and all error handling.

Purpose: This is the complete backend for ThreadTutor. After this plan, a developer can curl the endpoint and receive schema-valid Socratic teaching JSON from Claude. All 7 Phase 1 requirements (API-01 through API-07) will be satisfied.
Output: `app/api/chat/route.ts` -- a fully functional POST handler.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-api/01-CONTEXT.md
@.planning/phases/01-foundation-api/01-RESEARCH.md
@.planning/phases/01-foundation-api/01-01-SUMMARY.md
@lib/types.ts
@lib/system-prompt.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create the API route with all safeguards</name>
  <files>app/api/chat/route.ts</files>
  <action>
Create `app/api/chat/route.ts` implementing the complete POST handler. Follow the research example "Complete API Route with All Safeguards" from 01-RESEARCH.md.

**Request body shape:**
```typescript
{
  messages: Anthropic.MessageParam[];  // conversation history
  topic: string;                       // learning topic
  apiKey?: string;                     // BYOK key (optional in dev)
  existingConcepts?: Array<{ id: string; label: string }>;  // running concept list
}
```

**Implementation checklist (map to requirements):**

1. **Request parsing** (defensive):
   - Wrap `request.json()` in try/catch. Return 400 on invalid JSON.
   - Validate `messages` and `topic` are present. Return 400 with descriptive error if missing.

2. **API key resolution** (API-04, API-05):
   - `const key = apiKey || (process.env.NODE_ENV === "development" ? process.env.ANTHROPIC_API_KEY : null)`
   - If no key: return 401 with "No API key provided. Please enter your Anthropic API key."
   - NEVER log the key or full request body.

3. **Anthropic client** (per-request, API-04):
   - `const client = new Anthropic({ apiKey: key })` -- new client per request (BYOK means key changes per request)

4. **Claude API call** (API-02, API-03, API-06, API-07):
   - Model: `"claude-sonnet-4-5-20250929"` (from CLAUDE.md)
   - max_tokens: `2048` (API-06)
   - system: `buildSystemPrompt(topic, existingConcepts || [])` (API-02, API-07)
   - messages: pass through from request body
   - output_config: `{ format: zodOutputFormat(TurnResponseSchema) }` (API-03)
   - Import `zodOutputFormat` from `"@anthropic-ai/sdk/helpers/zod"`

5. **stop_reason validation** (API-06):
   - If `response.stop_reason !== "end_turn"`: return 422 with error message and the stop_reason value.
   - Only parse JSON when stop_reason is "end_turn".

6. **Response parsing**:
   - `const turnData = JSON.parse(response.content[0].text)`
   - Return as JSON with 200 status.
   - The content block type should be "text" with structured outputs. Access `.text` property.

7. **Error handling** (specific error types):
   - `Anthropic.AuthenticationError`: 401 with "Invalid API key. Please check your Anthropic API key."
   - `Anthropic.RateLimitError`: 429 with "Rate limit exceeded. Please wait a moment and try again."
   - Generic errors: 500 with "An error occurred while processing your request."
   - Log only `error.message` for generic errors (never full error which may contain key).

8. **Runtime** (API-01):
   - Do NOT export `const runtime = 'edge'`. Use Node.js runtime (default).
   - Node.js runtime with Vercel Fluid Compute gives 300s timeout.

Import `Anthropic` from `"@anthropic-ai/sdk"`. Import `zodOutputFormat` from `"@anthropic-ai/sdk/helpers/zod"`. Import `TurnResponseSchema` from `"@/lib/types"`. Import `buildSystemPrompt` from `"@/lib/system-prompt"`.
  </action>
  <verify>
`npm run build` succeeds. The file contains: zodOutputFormat import, TurnResponseSchema import, buildSystemPrompt import, per-request Anthropic client creation, max_tokens: 2048, stop_reason check, AuthenticationError catch, RateLimitError catch, NODE_ENV development gate for env var fallback. No `export const runtime` present.
  </verify>
  <done>
app/api/chat/route.ts exports a POST handler that: parses the request body, resolves the API key (BYOK with dev-only fallback), calls Claude with structured outputs and the Socratic system prompt, validates stop_reason before parsing, and handles auth/rate-limit/generic errors. All 7 API requirements (API-01 through API-07) are addressed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify build and test the route with curl</name>
  <files></files>
  <action>
Run the full verification suite to confirm Plan 02 is complete:

1. `npm run build` -- must succeed with no TypeScript errors
2. `npm run lint` -- must pass with no errors (warnings OK)
3. Verify the file structure matches the architecture:
   - `app/api/chat/route.ts` exists and exports POST
   - `lib/types.ts` exists with schema exports
   - `lib/system-prompt.ts` exists with buildSystemPrompt export
4. Grep for anti-patterns:
   - No `export const runtime` in any route file (confirms Node.js runtime)
   - No `console.log` of request body or API key
   - Confirm `process.env.NODE_ENV === "development"` guard exists
   - Confirm `stop_reason` check exists
   - Confirm `zodOutputFormat` is used (not raw JSON schema)
5. Verify no em dashes in system-prompt.ts (search for the unicode character U+2014)

If ANTHROPIC_API_KEY is available in .env.local, also start the dev server and test with curl:
```bash
curl -X POST http://localhost:3000/api/chat \
  -H "Content-Type: application/json" \
  -d '{"messages":[{"role":"user","content":"I want to learn about this topic"}],"topic":"Bitcoin proof-of-work"}'
```
Verify the response contains displayText, concepts, confidenceCheck, and journalEntry fields.

If no API key is available, skip the live curl test (the build verification is sufficient for this plan).
  </action>
  <verify>
`npm run build` exits 0. `npm run lint` exits 0. No `export const runtime` found. stop_reason check confirmed. zodOutputFormat confirmed. No em dashes in system-prompt.ts.
  </verify>
  <done>
Phase 1 build is clean. All files compile. Anti-pattern checks pass. The API route is ready for live testing when an API key is available.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` exits with code 0
2. `npm run lint` exits with code 0 (or only warnings, no errors)
3. `app/api/chat/route.ts` exports POST function
4. Route imports TurnResponseSchema from lib/types.ts
5. Route imports buildSystemPrompt from lib/system-prompt.ts
6. Route uses zodOutputFormat (not raw JSON schema)
7. Route checks stop_reason before parsing response
8. Route has BYOK key resolution with NODE_ENV === "development" guard
9. Route handles AuthenticationError and RateLimitError specifically
10. Route uses max_tokens: 2048
11. Route uses model "claude-sonnet-4-5-20250929"
12. Route passes existingConcepts to buildSystemPrompt
13. No export const runtime in any file
14. No em dashes in lib/system-prompt.ts
</verification>

<success_criteria>
The project builds cleanly. A developer can POST to /api/chat with a topic, messages, and API key and receive schema-valid structured JSON from Claude doing Socratic teaching. All 7 Phase 1 requirements (API-01 through API-07) are satisfied. The API route is the complete backend for ThreadTutor.
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-api/01-02-SUMMARY.md`
</output>
