---
phase: 01-foundation-api
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - tsconfig.json
  - next.config.ts
  - app/layout.tsx
  - app/page.tsx
  - lib/types.ts
  - lib/system-prompt.ts
  - .env.local.example
autonomous: true

must_haves:
  truths:
    - "TypeScript compiles without errors and `npm run build` succeeds"
    - "TurnResponseSchema defines displayText (string), concepts (array of ConceptSchema), confidenceCheck (nullable ConfidenceCheckSchema), journalEntry (nullable string)"
    - "ConceptSchema defines id, label, parentId (nullable string), description"
    - "ConfidenceCheckSchema defines question (string), assessment (optional enum: tracking/partial/confused), feedback (optional string)"
    - "buildSystemPrompt returns a string containing the topic, Socratic teaching rules, and concept list when provided"
    - "buildSystemPrompt with empty concepts includes first-turn instruction (parentId: null for root)"
    - "buildSystemPrompt with existing concepts lists their IDs for parentId reference"
  artifacts:
    - path: "lib/types.ts"
      provides: "Zod schemas and TypeScript types for Claude responses and session data"
      exports: ["ConceptSchema", "ConfidenceCheckSchema", "TurnResponseSchema", "Concept", "ConfidenceCheck", "TurnResponse", "Turn", "Session"]
    - path: "lib/system-prompt.ts"
      provides: "System prompt builder with concept list injection"
      exports: ["buildSystemPrompt"]
    - path: "package.json"
      provides: "Project dependencies and scripts"
      contains: "@anthropic-ai/sdk"
  key_links:
    - from: "lib/system-prompt.ts"
      to: "lib/types.ts"
      via: "imports Concept type or compatible interface for existingConcepts parameter"
      pattern: "import.*types"
---

<objective>
Set up the Next.js project with dependencies, define the Zod schemas for Claude's structured output, and build the system prompt function that enforces Socratic teaching.

Purpose: Establishes the foundation that the API route (Plan 02) imports from. The system prompt is the core product -- it determines whether Claude teaches through questioning or falls into lecturing.
Output: A buildable Next.js project with `lib/types.ts` (schemas + types) and `lib/system-prompt.ts` (prompt builder with concept injection).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-api/01-CONTEXT.md
@.planning/phases/01-foundation-api/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize Next.js project and install dependencies</name>
  <files>package.json, tsconfig.json, next.config.ts, app/layout.tsx, app/page.tsx, .env.local.example, .gitignore</files>
  <action>
Initialize a new Next.js project in the current directory (which already has .git, CLAUDE.md, etc.). Use `npx create-next-app@latest . --typescript --tailwind --eslint --app --src-dir=false --import-alias="@/*" --no-turbopack` to scaffold. If prompted about overwriting existing files, accept. After scaffold completes:

1. Install Phase 1 dependencies: `npm install @anthropic-ai/sdk zod@3`
2. Create `.env.local.example` with contents:
   ```
   # Your Anthropic API key (used for local development only)
   ANTHROPIC_API_KEY=sk-ant-your-key-here
   ```
3. Verify `.gitignore` includes `.env.local` (create-next-app should add it; if not, add it).
4. Clean up the default page.tsx to a minimal placeholder (remove default Next.js boilerplate content, keep the layout structure).
5. Verify `npm run build` succeeds with the scaffold.

Do NOT use Edge Runtime. Node.js runtime with Vercel Fluid Compute provides 300s timeout. Do not add `export const runtime = 'edge'` anywhere.
  </action>
  <verify>
`npm run build` exits with code 0. `node -e "require('@anthropic-ai/sdk')"` works. `node -e "require('zod')"` works. `.env.local.example` exists.
  </verify>
  <done>
Next.js project builds successfully with @anthropic-ai/sdk and zod@3 installed. .env.local.example documents the required env var. No Edge Runtime configured.
  </done>
</task>

<task type="auto">
  <name>Task 2: Define Zod schemas and TypeScript types</name>
  <files>lib/types.ts</files>
  <action>
Create `lib/types.ts` with the complete schema and type definitions for ThreadTutor. Follow the exact schema from research (01-RESEARCH.md "Zod Schema with All ThreadTutor Fields"):

**Zod schemas (used with output_config.format):**

1. `ConceptSchema` - z.object with:
   - `id`: z.string() -- human-readable slug (e.g., "proof-of-work")
   - `label`: z.string() -- display label
   - `parentId`: z.string().nullable() -- null for root concept, existing concept ID for children
   - `description`: z.string() -- contextual explanation, not a dictionary definition

2. `ConfidenceCheckSchema` - z.object with:
   - `question`: z.string() -- the check question Claude asks
   - `assessment`: z.enum(["tracking", "partial", "confused"]).optional() -- absent when asking, present when evaluating
   - `feedback`: z.string().optional() -- absent when asking, present when evaluating

3. `TurnResponseSchema` - z.object with:
   - `displayText`: z.string() -- Claude's teaching text
   - `concepts`: z.array(ConceptSchema) -- 1-3 new concepts per turn
   - `confidenceCheck`: ConfidenceCheckSchema.nullable() -- null on non-check turns
   - `journalEntry`: z.string().nullable() -- one-sentence summary (every assistant turn should have one, but nullable for safety)

**TypeScript types (inferred from Zod + application types):**

4. Export inferred types: `Concept`, `ConfidenceCheck`, `TurnResponse`

5. `Turn` interface (extends response with session metadata):
   - `turnNumber`: number
   - `role`: "assistant" | "user"
   - `displayText`: string
   - `concepts`: Concept[]
   - `confidenceCheck`: ConfidenceCheck | null
   - `journalEntry`: string | null

6. `Session` interface:
   - `id`: string
   - `topic`: string
   - `createdAt`: string
   - `turns`: Turn[]

Import from `zod` (not `zod/v3`). Use `z.infer<typeof Schema>` for type inference.
  </action>
  <verify>
`npx tsc --noEmit` succeeds. The file exports all 3 schemas and all 5 types (Concept, ConfidenceCheck, TurnResponse, Turn, Session).
  </verify>
  <done>
lib/types.ts compiles, exports ConceptSchema/ConfidenceCheckSchema/TurnResponseSchema for API use and Concept/ConfidenceCheck/TurnResponse/Turn/Session types for application use.
  </done>
</task>

<task type="auto">
  <name>Task 3: Build the system prompt with concept injection</name>
  <files>lib/system-prompt.ts</files>
  <action>
Create `lib/system-prompt.ts` with a `buildSystemPrompt(topic, existingConcepts)` function. This is the core product. Follow the research example but incorporate all decisions from 01-CONTEXT.md.

**Function signature:**
```typescript
interface ConceptRef {
  id: string;
  label: string;
}

export function buildSystemPrompt(
  topic: string,
  existingConcepts: ConceptRef[] = []
): string
```

**System prompt content must include (in this priority order):**

1. **Role and topic:** "You are a Socratic tutor. Your topic is: {topic}"

2. **Critical rules (negative constraints for Socratic drift prevention):**
   - "You MUST ask a question in every response. Never give a complete explanation without asking the student to reason about it first."
   - "Keep displayText under 150 words. Be concise."
   - "Every response must include a journalEntry (one sentence summarizing what was covered)."
   - "Do not use em dashes anywhere in your response."

3. **Teaching style (from CONTEXT.md decisions):**
   - Friendly but intellectually challenging Socratic professor tone
   - Introduce a concept in 1-2 sentences, then immediately ask the student to reason about it
   - Use analogies and real-world examples liberally
   - On correct answers: brief acknowledgment, then extend with a deeper insight or connection
   - Expect effort from the learner

4. **Confidence checks (every 2-3 teaching turns):**
   - Vary between explain-back and apply-it questions
   - Confused path: identify which specific part confused them, break just that part into smaller steps, do not re-explain everything
   - Partial path: acknowledge what they got right, fill the gap directly, continue forward
   - Tone is collaborative, not evaluative ("Yes, and here's why that matters..." not "Correct" or "Wrong")
   - When assessing, include both "assessment" and "feedback" fields in confidenceCheck

5. **Concept extraction:**
   - 1-3 new concepts per turn
   - Human-readable slug IDs (e.g., "proof-of-work", "hash-function")
   - Descriptions are contextual explanations, not dictionary definitions
   - Target 15-20 concepts over a full session

6. **Opening turn design:**
   - One sentence of framing, then immediately a question to gauge familiarity
   - Introduce exactly one concept: the root topic node
   - Include a journal entry

7. **Concept list injection (dynamic per-turn):**
   - If `existingConcepts` is non-empty: list all concept IDs and labels, instruct Claude to use exact IDs for parentId, set parentId to most logically relevant existing concept
   - If `existingConcepts` is empty: instruct that the first concept must have `parentId: null` (root node)

Do NOT use em dashes in the prompt itself. Use "to" or commas or rewording instead.
  </action>
  <verify>
`npx tsc --noEmit` succeeds. Running the function with a test topic returns a string containing the topic name, "MUST ask a question", concept instructions, and no em dashes. Running with existingConcepts returns a string containing those concept IDs.
  </verify>
  <done>
buildSystemPrompt returns a complete Socratic teaching prompt that includes the topic, negative constraints (must question, no lecturing), teaching style, confidence check rules, concept extraction rules, opening turn guidance, and the injected concept list. No em dashes in the prompt text.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` exits with code 0 (project compiles)
2. `npx tsc --noEmit` succeeds (all TypeScript is valid)
3. `lib/types.ts` exports 3 Zod schemas and 5 TypeScript types
4. `lib/system-prompt.ts` exports `buildSystemPrompt` function
5. System prompt contains "MUST ask a question" (anti-lecturing constraint)
6. System prompt contains "em dash" prohibition
7. System prompt injects concept IDs when existingConcepts provided
8. No `export const runtime = 'edge'` anywhere in the project
</verification>

<success_criteria>
The project builds, types compile, and the system prompt function produces a complete Socratic teaching prompt with concept injection. Plan 02 can import from both lib/types.ts and lib/system-prompt.ts to build the API route.
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-api/01-01-SUMMARY.md`
</output>
