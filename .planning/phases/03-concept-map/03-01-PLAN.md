---
phase: 03-concept-map
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - lib/graph-layout.ts
  - components/concept-node.tsx
  - app/globals.css
autonomous: true

must_haves:
  truths:
    - "Concepts from turns are converted to React Flow nodes and edges with dagre-computed positions"
    - "Orphaned nodes (invalid parentId) are treated as roots instead of crashing"
    - "Custom node displays concept label in a rounded rectangle with muted indigo styling"
    - "New nodes have a fade-in + scale-up entry animation (~300ms)"
    - "Newest nodes get a fading glow highlight that dissipates after a few seconds"
    - "Hovering a node shows a tooltip with the concept description"
  artifacts:
    - path: "lib/graph-layout.ts"
      provides: "collectAllConcepts and buildGraphElements functions"
      exports: ["collectAllConcepts", "buildGraphElements"]
    - path: "components/concept-node.tsx"
      provides: "Custom ConceptNode component with hover tooltip"
      exports: ["ConceptNode"]
    - path: "app/globals.css"
      provides: "CSS keyframes and styles for concept node animation and React Flow dark mode overrides"
      contains: "concept-enter"
  key_links:
    - from: "lib/graph-layout.ts"
      to: "@dagrejs/dagre"
      via: "dagre layout computation"
      pattern: "dagre\\.layout"
    - from: "lib/graph-layout.ts"
      to: "lib/types.ts"
      via: "Concept and Turn type imports"
      pattern: "import.*from.*@/lib/types"
    - from: "components/concept-node.tsx"
      to: "@xyflow/react"
      via: "Handle and NodeToolbar imports"
      pattern: "import.*from.*@xyflow/react"
---

<objective>
Install React Flow and dagre dependencies, create the graph layout utility that converts Turn[] concepts into positioned React Flow nodes/edges, build the custom ConceptNode component with hover tooltip, and add CSS animations for node entry and glow highlights.

Purpose: These are the self-contained building blocks for the concept map. Separating layout logic and the node component from the integration refactor keeps each plan focused and testable independently.
Output: `lib/graph-layout.ts`, `components/concept-node.tsx`, updated `globals.css`, installed `@xyflow/react` and `@dagrejs/dagre`.
</objective>

<execution_context>
@/Users/yayseth/.claude/get-shit-done/workflows/execute-plan.md
@/Users/yayseth/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-concept-map/03-RESEARCH.md
@.planning/phases/03-concept-map/03-CONTEXT.md
@lib/types.ts
@app/globals.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create graph layout utility</name>
  <files>package.json, lib/graph-layout.ts</files>
  <action>
    1. Install `@xyflow/react` and `@dagrejs/dagre`:
       ```
       npm install @xyflow/react @dagrejs/dagre
       ```
       No `@types/dagre` needed -- `@dagrejs/dagre` v2.0.4 ships its own types.

    2. Create `lib/graph-layout.ts` with two exported functions:

       **`collectAllConcepts(turns: Turn[])`**: Iterate turns, collect all concepts deduplicated by id (Set-based), returning `Array<Concept & { turnNumber: number }>`. This preserves which turn introduced each concept for recency highlighting and click-to-scroll.

       **`buildGraphElements(concepts, latestTurnNumber, direction)`**: Convert concept array into React Flow `Node[]` and `Edge[]` with dagre-computed positions.
       - Create a fresh `dagre.graphlib.Graph` each call (anti-pattern: reusing across renders)
       - Set graph options: `{ rankdir: direction, nodesep: 40, ranksep: 60 }`
       - Use `NODE_WIDTH = 160` and `NODE_HEIGHT = 40` constants
       - For each concept, add a dagre node
       - For each concept with a non-null parentId, validate `knownIds.has(concept.parentId)` before creating an edge (MAP-06: orphaned nodes become roots silently, no crash)
       - Run `dagre.layout(g)` then map positions back to React Flow nodes
       - Each node uses `type: 'concept'` and `data` with: `{ label, description, turnNumber, isNew: turnNumber === latestTurnNumber }`
       - Edges use default type (bezier curves per user decision)
       - Default direction: `'TB'` (top-to-bottom; Claude's discretion per CONTEXT.md)

       Export a `ConceptNodeData` interface: `{ label: string; description: string; turnNumber: number; isNew: boolean }`.

       Import types from `@xyflow/react` as type-only imports (`import type { Node, Edge }`) and from `@/lib/types` (`import type { Concept, Turn }`).
  </action>
  <verify>
    `npx tsc --noEmit` passes with no errors on `lib/graph-layout.ts`. Verify the file exports `collectAllConcepts`, `buildGraphElements`, and `ConceptNodeData`.
  </verify>
  <done>
    `lib/graph-layout.ts` exports `collectAllConcepts` and `buildGraphElements`. An empty turns array returns empty nodes/edges. Concepts with invalid parentIds produce no edges (no crash). `@xyflow/react` and `@dagrejs/dagre` are in package.json dependencies.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create custom ConceptNode component and CSS animations</name>
  <files>components/concept-node.tsx, app/globals.css</files>
  <action>
    1. Create `components/concept-node.tsx`:
       - Export a memoized `ConceptNode` component (`memo(...)` with `displayName = 'ConceptNode'`)
       - Accept `NodeProps` from `@xyflow/react`, cast `data` to `ConceptNodeData` from `@/lib/graph-layout`
       - Use `useState` for `hovered` state
       - Render `NodeToolbar` from `@xyflow/react` with `isVisible={hovered}`, `position={Position.Top}`, `offset={8}`
         - Tooltip content: rounded-lg container with `bg-zinc-800 border border-zinc-700 px-3 py-2 text-xs text-zinc-300 max-w-[200px] shadow-lg` showing `description`
       - Render the node body as a div with class `concept-node` (plus `concept-node--new` when `data.isNew`)
         - `onMouseEnter` / `onMouseLeave` toggle hovered state
         - Contains `Handle` components for `target` (Position.Top) and `source` (Position.Bottom), both visually hidden: `className="!bg-transparent !border-0 !w-0 !h-0"`
         - Label span: `text-xs font-medium text-zinc-200 px-3 py-2` showing `data.label`
       - The node should be a rounded rectangle with muted indigo styling per user decision
       - No node dragging (handled at ReactFlow level, not here)

    2. Add to `app/globals.css` (after existing keyframes):

       **React Flow dark mode overrides** to match the #1a1a1e theme:
       ```css
       .react-flow.dark {
         --xy-background-color-default: transparent;
         --xy-node-background-color-default: #2a2a30;
         --xy-node-border-default: 1px solid #4338ca40;
         --xy-node-color-default: #e8e8ec;
         --xy-edge-stroke-default: #4338ca60;
       }
       ```

       **Concept node styles:**
       - `.concept-node`: `background: #2a2a30`, `border: 1px solid #4338ca40` (muted indigo), `border-radius: 8px`, transitions for border-color and box-shadow (0.2s), `cursor: pointer`, `animation: concept-enter 300ms ease-out`
       - `.concept-node:hover`: `border-color: #6366f1`
       - `.concept-node--new`: brighter border `#6366f180`, glow `box-shadow: 0 0 12px #6366f130`, dual animation: `concept-enter 300ms ease-out, concept-glow-fade 3s ease-out 300ms forwards`

       **Keyframes:**
       - `concept-enter`: from `opacity: 0; transform: scale(0.85)` to `opacity: 1; transform: scale(1)`
       - `concept-glow-fade`: from brighter border + glow to default muted border + no shadow (the "newest" highlight fading after a few seconds)
  </action>
  <verify>
    `npx tsc --noEmit` passes. `app/globals.css` contains `concept-enter`, `concept-glow-fade`, and `.react-flow.dark` styles.
  </verify>
  <done>
    `ConceptNode` component renders a rounded rectangle with label, hidden handles, hover tooltip via NodeToolbar, and CSS-driven entry animation. New nodes get a fading glow highlight. React Flow dark mode variables match the app theme.
  </done>
</task>

</tasks>

<verification>
- `npm run build` succeeds (no build errors from new files or dependencies)
- `lib/graph-layout.ts` and `components/concept-node.tsx` have no TypeScript errors
- `globals.css` contains React Flow dark mode overrides and concept node animations
- `@xyflow/react` and `@dagrejs/dagre` listed in package.json dependencies
</verification>

<success_criteria>
- Graph layout utility correctly converts Turn[] concepts into positioned Node[] and Edge[] arrays
- Orphaned nodes (bad parentId) silently become roots with no edges, no crash
- ConceptNode displays label only by default, shows description tooltip on hover
- CSS animations provide fade-in + scale-up on entry, fading glow for newest nodes
- All files pass TypeScript type checking
</success_criteria>

<output>
After completion, create `.planning/phases/03-concept-map/03-01-SUMMARY.md`
</output>
