---
phase: 03-concept-map
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - components/conversation-shell.tsx
  - components/conversation-panel.tsx
  - components/concept-map.tsx
  - components/message.tsx
autonomous: true

must_haves:
  truths:
    - "Concepts appear as nodes in a React Flow directed graph with dagre auto-layout"
    - "Root concept starts centered in the viewport"
    - "New nodes animate in as each teaching turn introduces concepts"
    - "Edges connect child concepts to parent concepts via bezier curves"
    - "Hovering a concept node shows a floating tooltip with the description"
    - "Clicking a concept node scrolls the conversation panel to the turn where it was introduced"
    - "Empty state shows muted placeholder text before any concepts exist"
    - "Fit-all button resets viewport to show all nodes"
    - "No node dragging -- users pan/zoom viewport only"
  artifacts:
    - path: "components/concept-map.tsx"
      provides: "React Flow graph component with ReactFlowProvider wrapper"
      exports: ["ConceptMap"]
    - path: "components/conversation-shell.tsx"
      provides: "Lifted useConversation state, passes turns to ConceptMap and state to ConversationPanel"
      exports: ["ConversationShell"]
    - path: "components/conversation-panel.tsx"
      provides: "Refactored to receive state/sendMessage/clearError as props instead of calling useConversation internally"
      exports: ["ConversationPanel"]
    - path: "components/message.tsx"
      provides: "data-turn-number attribute on message wrapper for click-to-scroll targeting"
      exports: ["Message"]
  key_links:
    - from: "components/conversation-shell.tsx"
      to: "lib/use-conversation.ts"
      via: "useConversation hook call (lifted from ConversationPanel)"
      pattern: "useConversation\\(topic.*apiKey\\)"
    - from: "components/conversation-shell.tsx"
      to: "components/concept-map.tsx"
      via: "turns prop and onConceptClick callback"
      pattern: "ConceptMap.*turns=.*state\\.turns"
    - from: "components/conversation-shell.tsx"
      to: "components/conversation-panel.tsx"
      via: "state, sendMessage, clearError props"
      pattern: "ConversationPanel.*state=.*sendMessage="
    - from: "components/concept-map.tsx"
      to: "lib/graph-layout.ts"
      via: "collectAllConcepts and buildGraphElements imports"
      pattern: "import.*from.*@/lib/graph-layout"
    - from: "components/concept-map.tsx"
      to: "components/concept-node.tsx"
      via: "nodeTypes registration at module scope"
      pattern: "nodeTypes.*=.*concept.*ConceptNode"
    - from: "components/message.tsx"
      to: "conversation scroll targeting"
      via: "data-turn-number attribute on message wrapper div"
      pattern: "data-turn-number"
---

<objective>
Create the ConceptMap component, lift useConversation state into ConversationShell, refactor ConversationPanel to accept props, wire click-to-scroll between map and conversation, and add the fit-all button. This connects all the building blocks from Plan 01 into a working concept map integrated with the conversation.

Purpose: This is the integration plan that replaces the placeholder with a live, interactive concept map. The state lift also prepares the architecture for Phase 4 (Learning Journal) which needs the same turns data.
Output: Working concept map in the left panel that builds progressively during conversation, with click-to-scroll and fit-all interactions.
</objective>

<execution_context>
@/Users/yayseth/.claude/get-shit-done/workflows/execute-plan.md
@/Users/yayseth/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-concept-map/03-RESEARCH.md
@.planning/phases/03-concept-map/03-CONTEXT.md
@.planning/phases/03-concept-map/03-01-SUMMARY.md
@lib/types.ts
@lib/use-conversation.ts
@components/conversation-shell.tsx
@components/conversation-panel.tsx
@components/message.tsx
@components/concept-map-placeholder.tsx
@lib/graph-layout.ts
@components/concept-node.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ConceptMap component and refactor state lifting</name>
  <files>components/concept-map.tsx, components/conversation-shell.tsx, components/conversation-panel.tsx, components/message.tsx</files>
  <action>
    **Step 1: Create `components/concept-map.tsx`**

    Create a `ConceptMap` component that wraps an inner component in `ReactFlowProvider`:

    - `ConceptMap` (outer): Accepts `{ turns: Turn[]; onConceptClick?: (turnNumber: number) => void }`. Wraps `ConceptMapInner` in `ReactFlowProvider`.

    - `ConceptMapInner` (inner, not exported): Uses `useReactFlow` for `fitView`.
      - Derive concepts via `useMemo(() => collectAllConcepts(turns), [turns])`
      - Compute `latestTurnNumber` from the last turn in the array
      - Derive `{ nodes, edges }` via `useMemo(() => buildGraphElements(concepts, latestTurnNumber, 'TB'), [concepts, latestTurnNumber])`
      - Track `prevConceptCount` with `useRef` to detect when new concepts appear
      - On new concepts (count increased), call `fitView({ duration: 300, padding: 0.2 })` after a 50ms setTimeout (so React Flow has positioned nodes). Per user decision: auto-fit when new nodes appear. Start with this approach; conditional viewport check can refine later.
      - Handle node click: extract `turnNumber` from `node.data` and call `onConceptClick`
      - Empty state (concepts.length === 0): render centered muted text "Concepts will appear here as you learn" per user decision
      - Non-empty: render `<ReactFlow>` with:
        - `nodes={nodes}` and `edges={edges}` as controlled props (not useNodesState -- anti-pattern for derived state)
        - `nodeTypes={nodeTypes}` (defined at MODULE SCOPE: `const nodeTypes = { concept: ConceptNode }`)
        - `onNodeClick={handleNodeClick}`
        - `nodesDraggable={false}` (user decision: no dragging, dagre controls positioning)
        - `nodesConnectable={false}`
        - `elementsSelectable={false}`
        - `colorMode="dark"`
        - `fitView` with `fitViewOptions={{ padding: 0.3 }}`
        - `proOptions={{ hideAttribution: true }}`
        - `minZoom={0.2}`, `maxZoom={2}`
      - Add a `<Panel position="bottom-right">` with a fit-all button:
        - Small icon button with `bg-zinc-800 border border-zinc-700 p-1.5 text-zinc-400 hover:text-zinc-200 hover:bg-zinc-700 transition-colors`
        - Use an inline SVG for a "maximize/fit" icon (4 outward-pointing arrows or similar)
        - `onClick={() => fitView({ duration: 300, padding: 0.2 })}`
        - `title="Fit all nodes"`
      - Import `@xyflow/react/dist/style.css` at the top of this file (critical: without it edges are invisible)

    **Step 2: Lift `useConversation` into `ConversationShell`**

    Update `components/conversation-shell.tsx`:
    - Import `useConversation` from `@/lib/use-conversation`
    - Import `ConceptMap` from `@/components/concept-map` (replaces ConceptMapPlaceholder import)
    - Call `useConversation(topic, apiKey)` in ConversationShell and get `{ state, sendMessage, clearError }`
    - Create a `handleConceptClick` callback that scrolls the conversation panel to the turn:
      ```
      const handleConceptClick = useCallback((turnNumber: number) => {
        const el = document.querySelector(`[data-turn-number="${turnNumber}"]`);
        el?.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, []);
      ```
    - Replace `<ConceptMapPlaceholder />` with `<ConceptMap turns={state.turns} onConceptClick={handleConceptClick} />`
    - Pass `state`, `sendMessage`, `clearError` as props to `ConversationPanel` instead of `topic` and `apiKey`
    - Keep `JournalPlaceholder` as-is (Phase 4 will replace it)
    - Add required imports: `useCallback` from react, `useConversation`

    **Step 3: Refactor `ConversationPanel` to accept props**

    Update `components/conversation-panel.tsx`:
    - Change interface from `{ topic: string; apiKey: string }` to:
      ```typescript
      interface ConversationPanelProps {
        state: { turns: Turn[]; isLoading: boolean; error: string | null; pendingConfidenceCheck: boolean };
        sendMessage: (text: string) => Promise<void>;
        clearError: () => void;
      }
      ```
    - Remove the `useConversation` import and hook call
    - Remove the `topic` and `apiKey` parameters
    - Destructure `{ state, sendMessage, clearError }` from props instead
    - Keep the `didSendOpening` ref and opening turn auto-send useEffect, but since topic is no longer a prop, move the opening message send to ConversationShell instead:
      - Actually, the opening message needs `sendMessage` which is now in ConversationShell. Add a `useEffect` in ConversationShell that sends the opening message:
        ```
        const didSendOpening = useRef(false);
        useEffect(() => {
          if (didSendOpening.current) return;
          didSendOpening.current = true;
          sendMessage(`I'd like to learn about ${topic}`);
        }, [topic, sendMessage]);
        ```
      - Remove the opening turn logic from ConversationPanel entirely
    - Everything else stays the same (input handling, scroll behavior, confidence check logic, skeleton, error banner)
    - Import `Turn` type since ConversationPanel now needs it in the prop interface

    **Step 4: Add `data-turn-number` to Message component**

    Update `components/message.tsx`:
    - Add `data-turn-number={turn.turnNumber}` attribute to the outermost div in both the user and assistant message branches
    - This enables `document.querySelector('[data-turn-number="N"]')` for click-to-scroll from the concept map
    - No other changes to the Message component
  </action>
  <verify>
    1. `npm run build` passes with no errors
    2. `npx tsc --noEmit` passes
    3. Verify the concept-map-placeholder.tsx import is gone from conversation-shell.tsx
    4. Verify `useConversation` is imported in conversation-shell.tsx (not conversation-panel.tsx)
    5. Verify `data-turn-number` appears in message.tsx
  </verify>
  <done>
    The concept map renders in the left panel with React Flow. Concepts from conversation turns appear as nodes with dagre-computed positions. Edges connect children to parents via bezier curves. Root concept starts centered (fitView on initial render). New nodes animate in with fade+scale. Hovering shows description tooltip. Clicking a node scrolls the conversation to that turn. Empty state shows placeholder text. Fit-all button resets viewport. No node dragging. useConversation state is lifted to ConversationShell, enabling both the concept map and the future learning journal to access turns.
  </done>
</task>

</tasks>

<verification>
- `npm run build` succeeds with zero errors
- `npm run lint` passes
- ConceptMapPlaceholder is no longer imported anywhere (replaced by ConceptMap)
- useConversation is called in ConversationShell (not ConversationPanel)
- ConversationPanel receives state/sendMessage/clearError as props
- Message component has data-turn-number attributes for scroll targeting
- ReactFlow renders with colorMode="dark", nodesDraggable=false, and bezier edges
- nodeTypes is defined at module scope (not inside component)
- Empty concept state shows "Concepts will appear here as you learn"
- Fit-all button is present in bottom-right Panel
</verification>

<success_criteria>
- Concepts appear as nodes in a React Flow directed graph with dagre auto-layout, root centered
- New nodes animate in subtly with each teaching turn
- Edges connect child to parent concepts; orphans are handled gracefully
- Hovering a node shows a floating tooltip with the concept description
- Clicking a node scrolls the conversation to the relevant turn
- Empty state shows muted placeholder text
- Fit-all button resets the viewport to show all nodes
- No node dragging; users pan/zoom viewport only
</success_criteria>

<output>
After completion, create `.planning/phases/03-concept-map/03-02-SUMMARY.md`
</output>
