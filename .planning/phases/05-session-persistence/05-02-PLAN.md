---
phase: 05-session-persistence
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - components/session-list.tsx
  - components/topic-picker.tsx
  - components/conversation-shell.tsx
autonomous: true

must_haves:
  truths:
    - "A past sessions list shows previously saved sessions with topic, date, and turn count"
    - "User can load any past session and view its full conversation, concept map, and journal"
    - "User can delete a past session from the list"
    - "User can export any session as a downloadable JSON file"
  artifacts:
    - path: "components/session-list.tsx"
      provides: "Past sessions list UI with load, delete, and export actions"
      exports: ["SessionList"]
    - path: "components/topic-picker.tsx"
      provides: "Session list integration on the topic picker screen"
      contains: "SessionList"
    - path: "components/conversation-shell.tsx"
      provides: "Export button in header, support for loading past sessions in read-only view"
      contains: "downloadSessionAsJson"
  key_links:
    - from: "components/session-list.tsx"
      to: "lib/session-storage.ts"
      via: "listSessions, deleteSession, loadSession, downloadSessionAsJson"
      pattern: "listSessions|deleteSession|loadSession|downloadSessionAsJson"
    - from: "components/topic-picker.tsx"
      to: "components/session-list.tsx"
      via: "SessionList rendered below topic input"
      pattern: "SessionList"
    - from: "components/topic-picker.tsx"
      to: "components/conversation-shell.tsx"
      via: "passes initialSession prop when loading a past session"
      pattern: "initialSession"
    - from: "components/conversation-shell.tsx"
      to: "lib/use-conversation.ts"
      via: "dispatches LOAD_SESSION when initialSession provided"
      pattern: "LOAD_SESSION"
---

<objective>
Build the session list UI and integrate session loading, deletion, and export into the topic picker and conversation shell.

Purpose: Users need to browse, load, delete, and export past sessions (SESS-03, SESS-04, SESS-05). This plan delivers the full UI for session management, completing the persistence feature.
Output: components/session-list.tsx (new), modified topic-picker.tsx and conversation-shell.tsx.
</objective>

<execution_context>
@/Users/yayseth/.claude/get-shit-done/workflows/execute-plan.md
@/Users/yayseth/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-session-persistence/05-RESEARCH.md
@.planning/phases/05-session-persistence/05-01-SUMMARY.md

@lib/types.ts
@lib/session-storage.ts
@lib/use-conversation.ts
@components/conversation-shell.tsx
@components/topic-picker.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SessionList component with load, delete, and export actions</name>
  <files>components/session-list.tsx</files>
  <action>
    Create `components/session-list.tsx` as a "use client" component.

    Props interface:
    ```typescript
    interface SessionListProps {
      onLoadSession: (session: Session) => void;
    }
    ```

    Implementation:
    1. On mount, call `listSessions()` from `@/lib/session-storage` in a `useEffect` to populate local state (`sessions: SessionMeta[]`). Use the same hydration-safe pattern as topic-picker (loaded flag to avoid SSR mismatch).
    2. Display a list of sessions. Each item shows:
       - Topic name (text-zinc-200, font-medium)
       - Date formatted as relative or short date (e.g., "Feb 15" or "Today") using `new Date(createdAt).toLocaleDateString()` -- keep it simple, no date library
       - Turn count (e.g., "12 turns" in text-zinc-500)
    3. Each session row has three action buttons (small, icon-style or text):
       - **Load**: calls `loadSession(id)` from session-storage, then calls `onLoadSession(session)` with the full Session object. If loadSession returns null (data corrupted/missing), remove the stale entry from the index via `deleteSession(id)` and update local state.
       - **Export**: calls `loadSession(id)`, then `downloadSessionAsJson(session)` from session-storage
       - **Delete**: calls `deleteSession(id)` from session-storage, removes from local state
    4. Empty state: if no sessions, render nothing (component returns null). The topic picker should not show a "Past sessions" heading if there are no sessions.
    5. Styling: match the existing dark theme (#1a1a1e background, zinc color palette, indigo accents for interactive elements). Use border-zinc-700/50 dividers between session rows. Hover states on action buttons.
    6. Wrap the list in a section with heading "Past sessions" (text-sm font-medium text-zinc-400 uppercase tracking-wider).
  </action>
  <verify>
    - `npx tsc --noEmit` passes with no type errors
    - Component exports SessionList
    - Component imports from lib/session-storage (listSessions, loadSession, deleteSession, downloadSessionAsJson)
  </verify>
  <done>
    SessionList component renders past sessions from localStorage with load, delete, and export actions. Handles empty state, stale entries, and follows the existing dark theme.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate SessionList into TopicPicker and add export button to ConversationShell</name>
  <files>components/topic-picker.tsx, components/conversation-shell.tsx</files>
  <action>
    Modify `components/topic-picker.tsx`:
    1. Import `SessionList` from `@/components/session-list` and `Session` from `@/lib/types`.
    2. Add state for loaded session: `const [loadedSession, setLoadedSession] = useState<Session | null>(null)`.
    3. Render `<SessionList onLoadSession={setLoadedSession} />` below the topic input section (after the "Start learning" button area, before the API key input section). Only render after `apiKeyLoaded` is true (hydration safety).
    4. When a session is loaded (`loadedSession` is set), render `<ConversationShell>` the same way as when `started` is true, but pass additional props: `initialSession={loadedSession}`. The topic comes from `loadedSession.topic`, and the apiKey from the existing state.
    5. Modify the `handleBack` callback to also clear `loadedSession`: `setLoadedSession(null)`.
    6. When `loadedSession` is non-null, skip the opening turn in ConversationShell (conversation already has turns). The ConversationShell will handle this via the initialSession prop.

    Modify `components/conversation-shell.tsx`:
    1. Add `initialSession?: Session` to `ConversationShellProps`.
    2. Import `downloadSessionAsJson` from `@/lib/session-storage`.
    3. When `initialSession` is provided:
       - Use `initialSession.id` as session ID (from ref, set on mount)
       - Use `initialSession.createdAt` as createdAt (from ref, set on mount)
       - Dispatch `LOAD_SESSION` with `{ turns: initialSession.turns, turnNumber: initialSession.turns.length }` in a useEffect on mount (run once, guarded by ref)
       - Skip the opening turn auto-send (check: if initialSession is provided, do not send the opening message)
    4. Add an export button to the header, next to the "New topic" button:
       - Small download icon or "Export" text button
       - On click: build the current Session object from refs + state.turns, call `downloadSessionAsJson(session)`
       - Style: same as "New topic" button (text-zinc-400 hover:bg-zinc-800 hover:text-zinc-200)
       - Only show when `state.turns.length > 0`
    5. When a past session is loaded, the auto-save effect still runs (updating the existing session in localStorage on any state changes, which is fine -- it's a no-op since turns don't change in a loaded read-only view).
  </action>
  <verify>
    - `npx tsc --noEmit` passes with no type errors
    - `npm run build` succeeds
    - Manual: start a conversation, complete a few turns, click "New topic". The past sessions list should show the session just created. Click it to load -- should display the full conversation with concept map and journal.
    - Manual: click "Export" in the header during a conversation -- a JSON file should download.
    - Manual: delete a session from the list -- it should disappear.
  </verify>
  <done>
    Topic picker shows past sessions list with load/delete/export. Loading a past session displays it in the full three-panel view. Export button in the header allows downloading the current session as JSON. The complete session persistence feature is functional.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- no type errors
2. `npm run build` -- production build succeeds
3. Manual: complete a conversation, click "New topic", verify session appears in past sessions list
4. Manual: load a past session from the list -- full conversation, concept map, and journal display correctly
5. Manual: export a session -- JSON file downloads with correct content
6. Manual: delete a session from the list -- removed from both the list and localStorage
7. Manual: refresh the browser on topic picker screen -- past sessions list still shows saved sessions
</verification>

<success_criteria>
- components/session-list.tsx exists and renders past sessions from localStorage
- topic-picker.tsx shows SessionList and supports loading past sessions
- conversation-shell.tsx accepts initialSession prop and has an Export button
- All SESS requirements (01-06) are satisfied
- Production build passes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-session-persistence/05-02-SUMMARY.md`
</output>
