---
phase: 05-session-persistence
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/session-storage.ts
  - app/api/sessions/route.ts
  - lib/use-conversation.ts
  - components/conversation-shell.tsx
autonomous: true

must_haves:
  truths:
    - "Sessions are automatically saved to localStorage after every turn"
    - "Refreshing the browser does not lose the current session data (it exists in localStorage)"
    - "In development mode, sessions are also written to /public/sessions/ on disk"
  artifacts:
    - path: "lib/session-storage.ts"
      provides: "localStorage CRUD for sessions with index management"
      exports: ["saveSession", "loadSession", "listSessions", "deleteSession", "downloadSessionAsJson"]
    - path: "app/api/sessions/route.ts"
      provides: "Dev-mode disk write endpoint for session JSON"
      exports: ["POST"]
    - path: "lib/use-conversation.ts"
      provides: "LOAD_SESSION action for hydrating conversation from saved session"
      contains: "LOAD_SESSION"
    - path: "components/conversation-shell.tsx"
      provides: "Session ID generation and auto-save effect"
      contains: "saveSession"
  key_links:
    - from: "components/conversation-shell.tsx"
      to: "lib/session-storage.ts"
      via: "saveSession called in useEffect watching state.turns"
      pattern: "saveSession"
    - from: "components/conversation-shell.tsx"
      to: "app/api/sessions/route.ts"
      via: "fetch POST in dev mode after localStorage save"
      pattern: "fetch.*api/sessions"
    - from: "lib/session-storage.ts"
      to: "localStorage"
      via: "getItem/setItem with threadtutor:session: prefix"
      pattern: "threadtutor:session:"
---

<objective>
Create the session persistence infrastructure: a localStorage storage module for session CRUD operations, a dev-mode API route for writing sessions to disk, and auto-save integration into the conversation shell.

Purpose: Sessions must survive browser refresh (SESS-01, SESS-02, SESS-06). This plan builds the data layer and wiring so that every turn is automatically persisted.
Output: lib/session-storage.ts, app/api/sessions/route.ts, modified use-conversation.ts and conversation-shell.tsx with auto-save.
</objective>

<execution_context>
@/Users/yayseth/.claude/get-shit-done/workflows/execute-plan.md
@/Users/yayseth/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-session-persistence/05-RESEARCH.md

@lib/types.ts
@lib/api-key.ts
@lib/use-conversation.ts
@components/conversation-shell.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create session storage module and dev-mode API route</name>
  <files>lib/session-storage.ts, app/api/sessions/route.ts</files>
  <action>
    Create `lib/session-storage.ts` following the `lib/api-key.ts` pattern (SSR-safe `typeof window` guards, namespaced localStorage keys). Must export:

    1. `saveSession(session: Session): void` -- Saves full session JSON to `threadtutor:session:{id}` key. Updates the sessions index at `threadtutor:sessions-index`. Wrap `localStorage.setItem` in try/catch for QuotaExceededError (log warning, do not throw).
    2. `loadSession(id: string): Session | null` -- Reads and parses session JSON by ID. Returns null if not found or parse fails.
    3. `listSessions(): SessionMeta[]` -- Reads the sessions index key. Returns array of `{ id, topic, createdAt, turnCount }`. Returns empty array if no index exists.
    4. `deleteSession(id: string): void` -- Removes session key and updates the index.
    5. `downloadSessionAsJson(session: Session): void` -- Creates Blob from `JSON.stringify(session, null, 2)`, generates object URL, triggers download via anchor element, revokes URL. Filename format: `threadtutor-{topic-slugified}-{id-first-8-chars}.json`.

    Internal helpers:
    - `updateIndex(session: Session): void` -- Upserts session metadata in the index array (update if ID exists, append if new). Sort by createdAt descending (newest first).
    - `removeFromIndex(id: string): void` -- Filters session out of index array.
    - `SessionMeta` interface: `{ id: string; topic: string; createdAt: string; turnCount: number }` -- exported for use by session-list component.

    Import `Session` from `@/lib/types`. Use the existing `Session` type exactly as-is (Phase 6 compatibility).

    Create `app/api/sessions/route.ts`:
    - POST handler that accepts a session JSON body
    - Guard: if `process.env.NODE_ENV !== 'development'`, return 403 with error message
    - Use `node:fs/promises` (writeFile, mkdir) and `node:path` (path.join)
    - Write to `path.join(process.cwd(), 'public', 'sessions', session.id + '.json')`
    - Create directory with `mkdir({ recursive: true })`
    - Pretty-print: `JSON.stringify(session, null, 2)`
    - Return `{ ok: true }` on success, `{ error: message }` with 500 on failure
  </action>
  <verify>
    - `npx tsc --noEmit` passes with no type errors
    - `lib/session-storage.ts` exports saveSession, loadSession, listSessions, deleteSession, downloadSessionAsJson, SessionMeta
    - `app/api/sessions/route.ts` exports POST
  </verify>
  <done>
    Session storage module provides full CRUD for localStorage sessions with index management. Dev-mode API route writes session JSON to public/sessions/ directory. All functions are SSR-safe.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add session identity, auto-save, and LOAD_SESSION to conversation flow</name>
  <files>lib/use-conversation.ts, components/conversation-shell.tsx</files>
  <action>
    Modify `lib/use-conversation.ts`:
    - Add a `LOAD_SESSION` action to the ConversationAction union: `{ type: "LOAD_SESSION"; payload: { turns: Turn[]; turnNumber: number } }`
    - Add the LOAD_SESSION case to the reducer: sets `turns` to `payload.turns`, `turnNumber` to `payload.turnNumber`, `isLoading: false`, `error: null`, `pendingConfidenceCheck: false`
    - This enables loading a past session's turns into the conversation state (used by Plan 02 for viewing past sessions)

    Modify `components/conversation-shell.tsx`:
    - Add imports: `saveSession` from `@/lib/session-storage`
    - Add session identity: generate a session ID using `crypto.randomUUID()` in a `useRef` (set once on mount, stable across re-renders). Store `createdAt` in a `useRef` as `new Date().toISOString()`.
    - Add auto-save useEffect: watch `state.turns`. When `state.turns.length > 0`, call `saveSession({ id: sessionIdRef.current, topic, createdAt: createdAtRef.current, turns: state.turns })`.
    - Add dev-mode disk write: after the localStorage save, if `process.env.NODE_ENV === 'development'`, fire-and-forget a `fetch('/api/sessions', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(session) })`. No await, no error handling needed (dev convenience, not critical path).
    - The opening turn auto-send effect remains unchanged. Auto-save will trigger naturally when the first turn arrives.
    - Do NOT change the ConversationShellProps interface yet (session loading UI comes in Plan 02).
  </action>
  <verify>
    - `npx tsc --noEmit` passes with no type errors
    - `npm run build` succeeds
    - Start dev server (`npm run dev`), open the app, start a conversation. After the first Claude response, check localStorage for a `threadtutor:session:{uuid}` key and a `threadtutor:sessions-index` key. Both should contain valid JSON.
    - Check `public/sessions/` directory for a `.json` file matching the session ID (dev mode only).
  </verify>
  <done>
    Every conversation turn is automatically saved to localStorage. Session has a stable UUID identity. In dev mode, sessions are also written to disk. The LOAD_SESSION action is available for Plan 02 to hydrate past sessions.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- no type errors
2. `npm run build` -- production build succeeds
3. Manual: start a conversation, check localStorage for session data after first response
4. Manual: verify `threadtutor:sessions-index` contains metadata array
5. Manual: check `public/sessions/` for disk-written session file (dev mode)
6. Manual: refresh the browser -- session data persists in localStorage (not yet loadable in UI, that's Plan 02)
</verification>

<success_criteria>
- lib/session-storage.ts exists with all 5 exported functions + SessionMeta type
- app/api/sessions/route.ts exists with POST handler gated by NODE_ENV
- useConversation reducer handles LOAD_SESSION action
- conversation-shell.tsx generates session ID and auto-saves on every turn change
- Production build passes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-session-persistence/05-01-SUMMARY.md`
</output>
