---
phase: 02-app-shell-live-conversation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/globals.css
  - package.json
  - lib/api-key.ts
  - lib/use-conversation.ts
autonomous: true

must_haves:
  truths:
    - "react-markdown and @tailwindcss/typography are installed and the typography plugin is registered in globals.css"
    - "API key can be read from and written to localStorage with SSR-safe helpers"
    - "Conversation state machine handles the full lifecycle: idle, loading, response received, confidence check pending, error"
    - "Full conversation history is sent to the API on every request with deduplicated concept list"
  artifacts:
    - path: "lib/api-key.ts"
      provides: "localStorage read/write/clear helpers for API key"
      exports: ["getApiKey", "setApiKey", "clearApiKey"]
    - path: "lib/use-conversation.ts"
      provides: "useReducer-based conversation state machine with API call logic"
      exports: ["useConversation"]
    - path: "app/globals.css"
      provides: "Tailwind typography plugin registration"
      contains: "@plugin \"@tailwindcss/typography\""
  key_links:
    - from: "lib/use-conversation.ts"
      to: "/api/chat"
      via: "fetch in sendMessage function"
      pattern: "fetch.*api/chat"
    - from: "lib/use-conversation.ts"
      to: "lib/types.ts"
      via: "imports Turn, TurnResponse, Concept types"
      pattern: "import.*from.*types"
---

<objective>
Install Phase 2 dependencies (react-markdown, @tailwindcss/typography), register the typography plugin in globals.css, create API key localStorage helpers, and build the useConversation state machine hook that manages turns, loading, errors, and API communication.

Purpose: These are the non-visual foundations that every Phase 2 component depends on. The conversation hook is the central nervous system of the app -- it manages state transitions, builds the Anthropic message history, and calls the API route.

Output: Two library modules (api-key.ts, use-conversation.ts), updated globals.css, and installed npm packages.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-app-shell-live-conversation/02-CONTEXT.md
@.planning/phases/02-app-shell-live-conversation/02-RESEARCH.md
@lib/types.ts
@app/api/chat/route.ts
@app/globals.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and register typography plugin</name>
  <files>package.json, app/globals.css</files>
  <action>
    Run `npm install react-markdown @tailwindcss/typography` to add both dependencies.

    Update `app/globals.css` to add the typography plugin registration. Add `@plugin "@tailwindcss/typography";` immediately after the `@import "tailwindcss";` line. This is the Tailwind CSS v4 way to register plugins (not tailwind.config.js).

    Also add the shimmer keyframe animation for the skeleton loading component (used in Plan 02):
    ```css
    @theme {
      --animate-shimmer: shimmer 2s infinite;
    }

    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }
    ```

    Do NOT modify the existing :root variables, @theme inline block, dark mode media query, or body styles.
  </action>
  <verify>
    Run `npm ls react-markdown @tailwindcss/typography` to confirm both packages are installed.
    Verify globals.css contains `@plugin "@tailwindcss/typography"` and the shimmer keyframe.
    Run `npm run build` to confirm the project compiles without errors.
  </verify>
  <done>react-markdown and @tailwindcss/typography are installed, the typography plugin is registered via @plugin directive in globals.css, and the shimmer animation keyframe is defined.</done>
</task>

<task type="auto">
  <name>Task 2: Create API key helpers and conversation state hook</name>
  <files>lib/api-key.ts, lib/use-conversation.ts</files>
  <action>
    **lib/api-key.ts:** Create localStorage helpers for the API key. Use the storage key `"threadtutor:apiKey"`. Export three functions:
    - `getApiKey(): string | null` -- returns null if `typeof window === "undefined"` (SSR safety) or if no key stored
    - `setApiKey(key: string): void` -- writes to localStorage
    - `clearApiKey(): void` -- removes from localStorage

    **lib/use-conversation.ts:** Create the conversation state machine as a custom hook. This is a `"use client"` module.

    State shape (ConversationState):
    ```
    turns: Turn[]
    isLoading: boolean
    error: string | null
    pendingConfidenceCheck: boolean
    turnNumber: number
    ```

    Actions (ConversationAction):
    - `SEND_MESSAGE` -- sets isLoading true, clears error
    - `RECEIVE_RESPONSE` with TurnResponse payload -- creates assistant Turn, appends to turns, increments turnNumber, sets pendingConfidenceCheck based on whether confidenceCheck is non-null and has no assessment yet, sets isLoading false
    - `ADD_USER_TURN` with string payload -- creates user Turn (role "user", empty concepts, null confidenceCheck/journalEntry), appends to turns, increments turnNumber, clears pendingConfidenceCheck
    - `SET_ERROR` with string payload -- sets error, clears isLoading
    - `CLEAR_ERROR` -- clears error

    Helper functions (not exported, internal to the module):
    - `buildMessages(turns: Turn[]): MessageParam[]` -- maps turns to `{role, content: turn.displayText}` for the Anthropic API. Import MessageParam from `@anthropic-ai/sdk/resources/messages`.
    - `collectConcepts(turns: Turn[]): Array<{id: string; label: string}>` -- iterates ALL turns, collects concepts, deduplicates by id.

    The exported `useConversation(topic: string, apiKey: string)` hook returns:
    - `state: ConversationState` (the reducer state)
    - `sendMessage(text: string): Promise<void>` -- dispatches ADD_USER_TURN, then SEND_MESSAGE, calls fetch to /api/chat with full message history + new message + topic + apiKey + existingConcepts, on success dispatches RECEIVE_RESPONSE, on error dispatches SET_ERROR. Uses useCallback.
    - `clearError(): void` -- dispatches CLEAR_ERROR

    The sendMessage function must:
    1. Dispatch ADD_USER_TURN with the user's text (so it appears immediately in the UI)
    2. Dispatch SEND_MESSAGE (sets loading true)
    3. Build the messages array from current turns PLUS the new user message
    4. Collect existing concepts from all turns
    5. POST to /api/chat with { messages, topic, apiKey, existingConcepts }
    6. On success: parse JSON, dispatch RECEIVE_RESPONSE
    7. On error: dispatch SET_ERROR with the error message

    Important: The sendMessage function needs access to the latest state. Use a ref pattern (`useRef` updated in a `useEffect`) to avoid stale closure issues with useCallback, since the function is memoized but needs current turns for buildMessages.

    Import types from `@/lib/types` (Turn, TurnResponse, Concept).
  </action>
  <verify>
    Run `npm run build` to confirm both files compile without TypeScript errors.
    Verify api-key.ts exports getApiKey, setApiKey, clearApiKey.
    Verify use-conversation.ts exports useConversation.
    Verify use-conversation.ts imports from @/lib/types and @anthropic-ai/sdk/resources/messages.
  </verify>
  <done>lib/api-key.ts provides SSR-safe localStorage helpers. lib/use-conversation.ts provides a useReducer-based state machine that manages the full conversation lifecycle and communicates with /api/chat, sending complete message history and deduplicated concepts on every request.</done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds with no errors
2. `npm ls react-markdown` shows react-markdown installed
3. `npm ls @tailwindcss/typography` shows @tailwindcss/typography installed
4. globals.css contains `@plugin "@tailwindcss/typography"`
5. lib/api-key.ts exports getApiKey, setApiKey, clearApiKey
6. lib/use-conversation.ts exports useConversation hook
7. use-conversation.ts includes fetch call to /api/chat with messages, topic, apiKey, existingConcepts
</verification>

<success_criteria>
The non-visual foundation for Phase 2 is in place: dependencies installed, typography plugin registered, API key persistence ready, and conversation state machine ready to be consumed by UI components in Plans 02 and 03.
</success_criteria>

<output>
After completion, create `.planning/phases/02-app-shell-live-conversation/02-01-SUMMARY.md`
</output>
